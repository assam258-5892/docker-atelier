#!/bin/bash

# 인터랙티브 메뉴 함수 (화살표 키 지원)
# 사용법: select_menu <initial_index> <options...>
select_menu() {
  local selected=$1
  shift
  local options=("$@")
  local count=${#options[@]}
  local key

  # 커서 숨기기
  tput civis

  # 메뉴 출력 함수
  print_menu() {
    for i in "${!options[@]}"; do
      if [ $i -eq $selected ]; then
        printf "  \e[7m%s\e[0m\n" "${options[$i]}"
      else
        printf "  %s\n" "${options[$i]}"
      fi
    done
  }

  # 초기 메뉴 출력
  print_menu

  # 키 입력 처리
  while true; do
    read -rsn1 key
    case "$key" in
      $'\x1b')  # ESC 시퀀스 시작
        read -rsn1 -t 1 seq1
        if [ -z "$seq1" ]; then
          # 순수 ESC 키 (취소)
          tput cnorm
          return 255
        fi
        read -rsn1 -t 1 seq2
        case "$seq1$seq2" in
          '[A')  # 위쪽 화살표
            ((selected--))
            [ $selected -lt 0 ] && selected=$((count - 1))
            ;;
          '[B')  # 아래쪽 화살표
            ((selected++))
            [ $selected -ge $count ] && selected=0
            ;;
        esac
        ;;
      '')  # Enter 키
        break
        ;;
      'q'|'Q')  # q로 취소
        tput cnorm
        return 255
        ;;
    esac
    # 메뉴 다시 그리기 (커서를 메뉴 시작으로 이동)
    printf "\e[%dA" $count
    print_menu
  done

  # 커서 복원
  tput cnorm

  return $selected
}

if [ -z "$1" ]; then
  # 현재 실행 중인 compose 프로젝트 감지 (컨테이너 라벨에서 직접 확인)
  current_project=$(docker ps --format '{{.Label "com.docker.compose.project.config_files"}}' 2>/dev/null | head -1)
  if [ -n "$current_project" ]; then
    # /path/to/docker-pg15.yml -> pg15
    current_project=$(basename "$current_project")
    current_project=${current_project#docker-}
    current_project=${current_project%.yml}
  fi

  echo "사용 가능한 docker-*.yml 목록 (↑↓ 선택, Enter 확인, ESC/q 취소):"

  # 파일 목록 수집
  menu_items=()
  base_names=()
  initial_idx=0
  idx=0
  for f in docker-*.yml; do
    base=${f#docker-}
    base=${base%.yml}
    base_names+=("$base")
    # 현재 실행 중인 프로젝트면 초기 선택으로 설정
    if [ "$base" = "$current_project" ]; then
      initial_idx=$idx
    fi
    # 키 생성
    num=$(echo "$base" | grep -o '[0-9]\+$')
    if [ -n "$num" ]; then
      key="$num"
    else
      key="${base:0:1}"
    fi
    menu_items+=("$key) $base")
    ((idx++))
  done

  # 메뉴 선택
  menu_count=${#menu_items[@]}
  select_menu $initial_idx "${menu_items[@]}"
  sel_idx=$?

  if [ $sel_idx -eq 255 ]; then
    echo "취소됨"
    exit 1
  fi

  set -- "${base_names[$sel_idx]}"
else
  # docker- 접두사를 제거한 base name에서 매칭
  # 1. 첫 글자로 시작하는 파일 우선 검색
  files=""
  for f in docker-*.yml; do
    base=${f#docker-}
    base=${base%.yml}
    case "$base" in
      "$1"*) files="$files $f" ;;
    esac
  done
  files=$(echo "$files" | xargs)
  count=$(echo "$files" | wc -w)

  # 2. 첫 글자 매칭이 없으면 포함 검색
  if [ "$count" -eq 0 ]; then
    for f in docker-*.yml; do
      base=${f#docker-}
      base=${base%.yml}
      if echo "$base" | grep -q "$1"; then
        files="$files $f"
      fi
    done
    files=$(echo "$files" | xargs)
    count=$(echo "$files" | wc -w)
  fi

  if [ "$count" -eq 1 ]; then
    base=${files#docker-}
    base=${base%.yml}
    set -- "$base"
  elif [ "$count" -gt 1 ]; then
    echo "입력 인자 '$1'를 포함하는 후보 파일:"
    for f in $files; do
      echo "  $f"
    done
    echo "여러 파일이 일치합니다. 정확한 이름을 입력하세요."
    exit 1
  else
    echo "입력 인자 '$1'를 포함하는 docker-*.yml 파일이 없습니다."
    exit 1
  fi
fi

docker compose -f docker-$1.yml up -d --remove-orphans --wait
